import numpy as np
import faiss
from sentence_transformers import SentenceTransformer

MODEL = "sentence-transformers/all-mpnet-base-v2"
THRESHOLD = 0.60
TOP_K = 3

# 预存问答
## 20条医学相关预存问答（字典格式，答案用三引号包裹）

qa = {
    "糖尿病是什么？": """糖尿病是一组以慢性高血糖为特征的代谢性疾病，主要由于胰岛素分泌不足或胰岛素作用受阻。长期高血糖可损害眼、肾、神经与心血管系统。""",
    "糖尿病的主要类型有哪些？": """主要有1型糖尿病（胰岛β细胞破坏，胰岛素依赖）、2型糖尿病（胰岛素抵抗与分泌不足，最常见）和妊娠期糖尿病（妊娠期间发生或首次发现的高血糖）。""",
    "糖尿病的常见症状有哪些？": """多饮、多尿、多食、体重下降、疲劳、视力模糊、伤口愈合慢、反复感染（如尿路或皮肤感染）。""",
    "如何监测血糖？": """用血糖仪或连续血糖监测（CGM）测量指尖或皮下间隙血糖。常见指标：空腹血糖、餐后2小时血糖、糖化血红蛋白（HbA1c）。建议定期记录并与医生讨论。""",
    "糖尿病的首选治疗原则是什么？": """综合干预：饮食控制、规律运动、体重管理、药物治疗（口服降糖药或胰岛素）、并发症筛查与管理。个体化治疗很重要。""",
    "如何控制2型糖尿病的饮食？": """原则：控制总能量摄入、均衡碳水化合物与膳食纤维、限制精制糖与高脂肪食物、少吃高盐、高热量零食。建议按医生或营养师制定的饮食计划分餐、记录碳水摄入。""",
    "糖尿病低血糖怎么办？": """若能吞咽且意识清醒：口服含糖饮料或果汁约15–20克快速吸收碳水（如4小勺糖或1片葡萄糖片），15分钟后复测血糖；若无效可再补充。若意识丧失或不能吞咽：立即呼叫急救，保持气道，必要时肌注或静脉注射葡萄糖或使用胰高血糖素急救笔。""",
    "糖尿病常见并发症有哪些？": """慢性并发症：糖尿病性视网膜病变、肾病（糖尿病肾病）、神经病变、心血管疾病（冠心病、中风）、周围血管病变（足病）。急性并发症：酮症酸中毒、高渗性高血糖状态。""",
    "有哪些方法预防糖尿病并发症？": """控制血糖（目标由医生确定）、控制血压与血脂、戒烟、定期眼底检查、尿微量白蛋白筛查、足部检查、管理体重与合理用药。""",
    "高血压跟心血管疾病的关系是什么？": """高血压是心血管疾病的重要危险因素。长期高血压可导致动脉粥样硬化、心肌肥厚、冠心病、心衰、脑卒中和肾脏损害。""",
    "如何急救心肌梗死疑似患者？": """立即拨打急救电话，安置患者平躺或半卧，松开紧身衣物，给氧（如有需要）、口服阿司匹林（除禁忌），在有条件下按医嘱给予硝酸甘油。保持监测并迅速送医院。""",
    "胸痛需要什么时候立即就医？": """胸痛伴随出汗、呼吸困难、放射至左臂/颈/下颌、恶心/呕吐、意识模糊或持续不缓解，应立即就医或拨打急救电话。""",
    "慢性阻塞性肺疾病（COPD）有哪些常见诱因？": """主要诱因：长期吸烟、职业粉尘与化学气体暴露、长期空气污染、反复呼吸道感染、遗传因素（如α1-抗胰蛋白酶缺乏）。""",
    "哮喘急性发作如何处理？": """让患者保持坐位、使用速效吸入β2受体激动剂（如沙丁胺醇）按说明喷吸，必要时重复用药，若症状严重或无改善，立即就医。""",
    "流感与普通感冒的区别？": """流感起病急、常伴高热、全身肌痛、明显乏力和咳嗽；普通感冒症状轻，多为鼻塞、流涕、喉咙痛。确诊可通过快速抗原或PCR检测。""",
    "新发发热如何自我处理并判断就医？": """若发热伴严重症状（呼吸困难、持续高热不退、意识改变、严重脱水、皮疹或四肢发凉紫绀）应立即就医。轻症可多休息、补液、对症退热并观察48小时，有恶化趋势及时就医。""",
    "常见传染病的基本预防措施有哪些？": """勤洗手、戴口罩（在呼吸道疾病高风险场景）、接种推荐疫苗、保持室内通风、避免与病患密切接触、合理处理食物与饮水。""",
    "中风的FAST识别法是什么？": """F（Face）：面部下垂；A（Arms）：举臂无力；S（Speech）：言语含糊或不清；T（Time）：出现上述任一项应立即就医/拨打急救电话。""",
    "如何处理烧伤（轻度）？": """用流动清水冲洗烧伤部位至少10–20分钟降温，去除紧身物品，小面积二度或一度可覆盖无菌敷料，口服止痛药物，若大面积、三度或呼吸道受累应立即就医。""",
    "服药安全的常见建议有哪些？": """按医嘱用药、遵循剂量与用药时间、避免与酒精或某些食物同用（如服用某些抗生素与酒精）、了解常见副作用、定期复诊与必要的实验室监测。"""
}
# 准备模型与向量
model = SentenceTransformer(MODEL)
questions = list(qa.keys())
answers = list(qa.values())
emb = model.encode(questions, convert_to_numpy=True).astype('float32')
# 归一化
emb /= np.linalg.norm(emb, axis=1, keepdims=True).clip(min=1e-10)

# FAISS 索引（内积）
d = emb.shape[1]
index = faiss.IndexFlatIP(d)
index = faiss.IndexIDMap(index)
ids = np.arange(len(questions)).astype('int64')
index.add_with_ids(emb, ids)

def answer(query: str, top_k: int = TOP_K, threshold: float = THRESHOLD):
    qv = model.encode([query], convert_to_numpy=True).astype('float32')
    qv /= np.linalg.norm(qv, axis=1, keepdims=True).clip(min=1e-10)
    scores, idxs = index.search(qv, top_k)
    res = []
    for idx, sc in zip(idxs[0], scores[0]):
        if idx == -1 or sc < threshold: continue
        res.append((answers[int(idx)], float(sc)))
    return res
if __name__ == "__main__":
    print("输入问题，输入 'exit' 或 'quit' 退出。")
    while True:
        q = input("Q: ").strip()
        if not q:
            continue
        if q.lower() in ("exit", "quit"):
            break
        results = answer(q)
        if not results:
            print("  未找到匹配（相似度低于阈值）。")
        else:
            for ans, s in results:
                print(f"  score={s:.4f}  answer={ans}")
