## ä½™å¼¦ç›¸ä¼¼åº¦ ä¸ L2 è·ç¦»

### ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆcosine similarityï¼‰
- å®šä¹‰è¦ç‚¹ï¼šä½™å¼¦ç›¸ä¼¼åº¦è¡¡é‡çš„æ˜¯ä¸¤ä¸ªå‘é‡çš„æ–¹å‘ä¸€è‡´æ€§ï¼Œä»…åæ˜ åˆ†é‡ä¹‹é—´çš„ç›¸å¯¹æ¯”é‡ï¼Œè€Œä¸å—å‘é‡æ€»ä½“é•¿åº¦ï¼ˆèŒƒæ•°ï¼‰çš„å½±å“ã€‚å¸¸åœ¨è¯­ä¹‰æˆ–åµŒå…¥æ¯”å¯¹åœºæ™¯ä½¿ç”¨ï¼Œä»¥åˆ¤æ–­â€œæ¨¡å¼/æ–¹å‘â€æ˜¯å¦ç›¸ä¼¼ã€‚  
- æ•°å€¼ç›´è§‚ï¼šåŒå‘æ—¶ç›¸ä¼¼åº¦æœ€å¤§ï¼ˆç†è®ºä¸Šä¸º 1ï¼‰ï¼Œæ­£äº¤æ—¶ç›¸ä¼¼åº¦ä¸º 0ï¼Œåå‘æ—¶ç›¸ä¼¼åº¦ä¸º -1ï¼›åœ¨ä»…å«éè´Ÿåˆ†é‡çš„æ­£ç©ºé—´ä¸­ï¼Œå€¼é€šå¸¸ä½äº 0 åˆ° 1 ä¹‹é—´ã€‚  
- ä¼˜ç‚¹ï¼ˆç®€è¦ï¼‰ï¼šå¯¹ç»Ÿä¸€ç¼©æ”¾é²æ£’ï¼›å¼ºè°ƒç›¸å¯¹åˆ†å¸ƒï¼Œé€‚åˆé«˜ç»´ç¨€ç–åµŒå…¥ï¼›è®¡ç®—å¼€é”€å°ï¼Œä¾¿äºå¤§è§„æ¨¡æ£€ç´¢ã€‚  
- å±€é™ï¼ˆç®€è¦ï¼‰ï¼šå¿½ç•¥ç»å¯¹å¹…å€¼ä¿¡æ¯ï¼›å¯¹æŸäº›ç»´åº¦ç›¸å¯¹æƒé‡æˆ–ç³»ç»Ÿæ€§åå·®æ•æ„Ÿï¼›å½“å‘é‡å«æœ‰è´Ÿå€¼æˆ–æ–¹å‘ä¿¡æ¯é‡è¦æ—¶éœ€è°¨æ…è§£é‡Šã€‚  
- å®åŠ¡å»ºè®®ï¼šè‹¥ç›®æ ‡æ˜¯æ¯”è¾ƒè¯­ä¹‰/æ¨¡å¼ï¼ˆå¦‚äººè„¸åµŒå…¥ã€å¥å‘é‡ï¼‰ï¼Œé€šå¸¸å…ˆåš L2 å½’ä¸€åŒ–å†ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è¿›è¡Œæ£€ç´¢æˆ–åŒ¹é…ï¼Œä»¥ä¿è¯æ¯”è¾ƒåªåŸºäºæ–¹å‘ã€‚

### L2 è·ç¦»ï¼ˆæ¬§æ°è·ç¦»ï¼‰
- å®šä¹‰è¦ç‚¹ï¼šL2 è·ç¦»é‡åŒ–ä¸¤ä¸ªå‘é‡åœ¨åŸå§‹æ•°å€¼ç©ºé—´ä¸Šçš„ç»å¯¹å·®å¼‚ï¼Œåæ˜ æ¯ä¸ªåˆ†é‡æ•°å€¼å·®çš„ç´¯ç§¯å½±å“ï¼Œæ—¢å—æ–¹å‘ä¹Ÿå—èŒƒæ•°å½±å“ã€‚  
- æ•°å€¼ç›´è§‚ï¼šè·ç¦»è¶Šå°è¡¨ç¤ºä¸¤å‘é‡åœ¨æ•°å€¼æ„ä¹‰ä¸Šè¶Šæ¥è¿‘ï¼›è·ç¦»ä¸º 0 è¡¨ç¤ºå‘é‡å®Œå…¨ç›¸ç­‰ã€‚  
- ä¼˜ç‚¹ï¼ˆç®€è¦ï¼‰ï¼šä¿ç•™å¹¶åæ˜ ç»å¯¹å¹…å€¼ä¿¡æ¯ï¼Œé€‚åˆåƒç´ çº§ã€å¼ºåº¦çº§æˆ–éœ€è¡¡é‡çœŸå®æ•°å€¼å·®å¼‚çš„åœºæ™¯ï¼›å¯¹å•ä¸€åˆ†é‡çš„å¤§åå·®æ•æ„Ÿï¼Œæœ‰åˆ©äºæ•æ‰æ˜¾è‘—å·®å¼‚ã€‚  
- å±€é™ï¼ˆç®€è¦ï¼‰ï¼šå¯¹ç»Ÿä¸€ç¼©æ”¾ä¸é²æ£’ï¼ˆæ•´ä½“æ”¾å¤§/ç¼©å°ä¼šæ”¹å˜è·ç¦»ï¼‰ï¼›åœ¨é«˜ç»´ç©ºé—´ä¸‹èŒƒæ•°æ•ˆåº”å¯èƒ½é™ä½åˆ¤åˆ«æ€§ï¼›å¯¹å™ªå£°æˆ–å¼‚å¸¸å€¼æ›´æ•æ„Ÿã€‚  
- å®åŠ¡å»ºè®®ï¼šå½“å‘é‡çš„ç»å¯¹å¹…å€¼æ‰¿è½½å®é™…ä¿¡æ¯ï¼ˆæœªå½’ä¸€åŒ–çš„ç‰¹å¾ã€åƒç´ å¼ºåº¦ã€ç‰©ç†é‡ï¼‰æˆ–éœ€ç²¾ç¡®åº¦é‡æ•°å€¼å·®å¼‚æ—¶ä¼˜å…ˆä½¿ç”¨ L2ã€‚

---

ğŸ¯ é€‰æ‹©é€ŸæŸ¥ï¼ˆä¸¥è°¨ç‰ˆï¼‰  
- æ¯”è¾ƒâ€œæ¨¡å¼/æ–¹å‘/è¯­ä¹‰â€ä¸”å¸Œæœ›å¿½ç•¥å°ºåº¦ï¼šå¯¹å‘é‡å…ˆåš L2 å½’ä¸€åŒ–ï¼Œç„¶åç”¨ä½™å¼¦ç›¸ä¼¼åº¦ã€‚  
- æ¯”è¾ƒâ€œç»å¯¹æ•°å€¼å·®å¼‚/å¹…å€¼â€ä¸”ä¸å½’ä¸€åŒ–ï¼šç”¨ L2 è·ç¦»ã€‚  
- å…¼é¡¾ä¸¤è€…ï¼šå¯åŒæ—¶è®¡ç®—ä½™å¼¦ä¸ L2ï¼Œå¹¶åŸºäºä»»åŠ¡è®¾å®šé˜ˆå€¼æˆ–åŠ æƒèåˆç»“æœã€‚

æ³¨æ„ï¼šåœ¨æ­£å¼ç³»ç»Ÿä¸­åº”æ˜ç¡®å‘é‡çš„å«ä¹‰ã€æ˜¯å¦åŒ…å«è´Ÿå€¼ã€ä»¥åŠæ˜¯å¦å·²æ ‡å‡†åŒ–ï¼Œå†æ®æ­¤é€‰æ‹©åº¦é‡ä¸é˜ˆå€¼ã€‚





"""
# æ–‡ä»¶ï¼šcompare_cosine_l2.py
# è¯´æ˜ï¼šä½¿ç”¨ sentence-transformers æå–å¥å­åµŒå…¥å¹¶æ¯”è¾ƒä½™å¼¦ç›¸ä¼¼åº¦ä¸ L2 è·ç¦»
# ä¾èµ–ï¼špip install sentence-transformers numpy
from sentence_transformers import SentenceTransformer, util
import numpy as np
from typing import List, Tuple
MODEL_NAME = "sentence-transformers/all-MiniLM-L6-v2"  # å¸¸ç”¨ Sentence-BERT æ¨¡å‹
def load_sentence_encoder(model_name: str = MODEL_NAME) -> SentenceTransformer:
    """
    åŠ è½½ SentenceTransformer æ¨¡å‹ï¼ˆè‡ªåŠ¨ä¸‹è½½æˆ–ä»ç¼“å­˜è¯»å–ï¼‰ã€‚
    è¿”å›å·²åŠ è½½çš„æ¨¡å‹å®ä¾‹ã€‚
    """
    return SentenceTransformer(model_name)
def get_embeddings(model: SentenceTransformer, texts: List[str],
                   normalize: bool = False, batch_size: int = 32) -> np.ndarray:
    """
    å°†æ–‡æœ¬åˆ—è¡¨ç¼–ç ä¸ºå¥å­åµŒå…¥å‘é‡ï¼ˆnumpy æ•°ç»„ï¼‰ã€‚
    å‚æ•°:
      - model: SentenceTransformer å®ä¾‹
      - texts: å¾…ç¼–ç å¥å­åˆ—è¡¨
      - normalize: è‹¥ä¸º Trueï¼Œè¿”å›çš„å‘é‡å·²åš L2 å½’ä¸€åŒ–ï¼ˆå•ä½å‘é‡ï¼‰
      - batch_size: æ‰¹å¤„ç†å¤§å°
    è¿”å›:
      - shape (n_texts, dim) çš„ numpy æ•°ç»„
    """
    # model.encode æ”¯æŒ convert_to_numpy å’Œ normalize_embeddings ä¸¤ä¸ªå‚æ•°
    emb = model.encode(texts,
                       batch_size=batch_size,
                       convert_to_numpy=True,
                       normalize_embeddings=normalize)
    return emb
def l2_distance(a: np.ndarray, b: np.ndarray) -> float:
    """è®¡ç®—ä¸¤ä¸ªå‘é‡çš„ L2ï¼ˆæ¬§æ°ï¼‰è·ç¦»ï¼Œè¿”å›æ ‡é‡"""
    return float(np.linalg.norm(a - b))
def safe_cosine_similarity(a: np.ndarray, b: np.ndarray) -> float:
    """
    è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œå¸¦é›¶å‘é‡ä¿æŠ¤ã€‚
    å¦‚æœä»»æ„å‘é‡èŒƒæ•°ä¸º 0ï¼Œè¿”å› 0.0ï¼ˆè¡¨ç¤ºä¸ç›¸ä¼¼ / æ— ä¿¡æ¯ï¼‰ã€‚
    """
    na = np.linalg.norm(a)
    nb = np.linalg.norm(b)
    if na == 0 or nb == 0:
        return 0.0
    return float(np.dot(a, b) / (na * nb))
def l2_normalize(v: np.ndarray) -> np.ndarray:
    """å¯¹å•ä¸ªå‘é‡åš L2 å½’ä¸€åŒ–ï¼ˆå•ä½å‘é‡ï¼‰ï¼›è‹¥èŒƒæ•°ä¸º 0 åˆ™è¿”å›åŸå‘é‡"""
    n = np.linalg.norm(v)
    return v / n if n > 0 else v
def compare_pair(a: np.ndarray, b: np.ndarray) -> Tuple[float, float]:
    """
    è¿”å›ç»™å®šä¸¤ä¸ªå‘é‡çš„ (cosine, l2) å€¼ï¼ˆæœªå½’ä¸€åŒ–æƒ…å†µä¸‹ï¼‰ã€‚
    """
    return safe_cosine_similarity(a, b), l2_distance(a, b)
if __name__ == "__main__":
    # åŠ è½½æ¨¡å‹ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
    model = load_sentence_encoder(MODEL_NAME)
    # ç¤ºä¾‹å¥å­ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
    texts = [
        "è¿™æ˜¯åŒä¸€æ„æ€çš„å¥å­ç¤ºä¾‹ä¸€ã€‚",
        "è¿™æ˜¯ä¸ä¸Šå¥è¯­ä¹‰æ¥è¿‘çš„å¦ä¸€ç§è¡¨è¿°ã€‚",
        "è¿™æ˜¯ä¸€æ¡è¯­ä¹‰å®Œå…¨ä¸åŒçš„å¥å­ã€‚"
    ]
    # 1) è·å–æœªå½’ä¸€åŒ–çš„åµŒå…¥ï¼ˆåŸå§‹å‘é‡ï¼‰
    embeddings = get_embeddings(model, texts, normalize=False)  # shape (3, dim)
    # 2) è®¡ç®—æœªå½’ä¸€åŒ–æƒ…å†µä¸‹çš„ä½™å¼¦ä¸ L2ï¼ˆç›´æ¥ä½¿ç”¨ embedding å‘é‡ï¼‰
    cos_12, l2_12 = compare_pair(embeddings[0], embeddings[1])
    cos_13, l2_13 = compare_pair(embeddings[0], embeddings[2])
    print("=== æœªå½’ä¸€åŒ–åµŒå…¥ ===")
    print(f"cos(text0, text1) = {cos_12:.6f}    L2 = {l2_12:.6f}")
    print(f"cos(text0, text2) = {cos_13:.6f}    L2 = {l2_13:.6f}")
    # 3) å¦‚æœéœ€è¦æ£€ç´¢å¸¸ç”¨çš„å•ä½å‘é‡æ¯”è¾ƒï¼šç›´æ¥è·å–å½’ä¸€åŒ–åµŒå…¥
    embeddings_norm = get_embeddings(model, texts, normalize=True)  # æ¯è¡Œå·²å•ä½åŒ–
    # å½’ä¸€åŒ–åç”¨å†…ç§¯ç­‰ä»·äºä½™å¼¦
    dot_12 = float(np.dot(embeddings_norm[0], embeddings_norm[1]))
    dot_13 = float(np.dot(embeddings_norm[0], embeddings_norm[2]))
    l2norm_12 = l2_distance(embeddings_norm[0], embeddings_norm[1])
    l2norm_13 = l2_distance(embeddings_norm[0], embeddings_norm[2])
    print("\n=== L2 å½’ä¸€åŒ–åçš„åµŒå…¥ï¼ˆå•ä½å‘é‡ï¼‰ ===")
    print(f"dot(text0, text1) [ç­‰äºä½™å¼¦] = {dot_12:.6f}    L2 = {l2norm_12:.6f}")
    print(f"dot(text0, text2) [ç­‰äºä½™å¼¦] = {dot_13:.6f}    L2 = {l2norm_13:.6f}")

    # 4) å¯é€‰ï¼šç›´æ¥ä½¿ç”¨ sentence-transformers æä¾›çš„ util.cos_sim è®¡ç®—æ‰¹é‡ä½™å¼¦ç›¸ä¼¼åº¦çŸ©é˜µ
    #    util.cos_sim è¿”å› torch å¼ é‡æˆ– numpyï¼ˆå–å†³äºè¾“å…¥ï¼‰ï¼Œå¯ç”¨äºå¤§è§„æ¨¡æ£€ç´¢
    cos_matrix = util.cos_sim(embeddings, embeddings)  # shape (3,3)
    print("\nä½™å¼¦ç›¸ä¼¼åº¦çŸ©é˜µï¼ˆæœªå½’ä¸€åŒ–åµŒå…¥ï¼‰:")
    print(cos_matrix.numpy())  # æ‰“å°ä¸º numpy æ•°ç»„
"""

